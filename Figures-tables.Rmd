---
title: "Flood damage assessment V2 visuals"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls()) # Clears workspace
knitr::opts_chunk$set(echo = TRUE)

# Packages
PKG <- c("multcomp","multcompView","tidyverse","scales","gridExtra","ggthemes","viridis","knitr","sf","exactextractr","raster","data.table","sf", "RColorBrewer","tmap", "ggpubr", "patchwork") # https://rud.is/b/2016/02/14/making-faceted-heatmaps-with-ggplot2/

for (p in PKG) {
  if(!require(p,character.only = TRUE)) {  
    install.packages(p)
    require(p,character.only = TRUE)}
}
rm(PKG,p)
renv::snapshot()
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r, include=FALSE}
# Downloading data using external script
#source("Figures-tables-data.R")

```

## Net damage from all OLU protection scenarios across OLUs, compared to baseline conditions, for all SLR scenarios  


```{r, echo=FALSE}
# To use an asymmetric diverging palette, use a symmetric one and drop some from one or both sides https://www.r-bloggers.com/how-to-expand-color-palette-with-ggplot-and-rcolorbrewer/ 
getPalette<-colorRampPalette(brewer.pal(25, "RdBu")) # function, change if different palette is desired
cols<-getPalette(25) # Needs to be odd number to ensure midpoint color is correct
#show_col(cols)
labs<-expression(paste("10"^"9"),paste("10"^"8"),paste("10"^"7"),paste("-10"^"7"),paste("-10"^"8"),paste("-10"^"9"),paste("-10"^"10"))
#colscale<-unname(quantile(tresult.ni$net.damage, probs = seq(0, 1, 1/4)))

# Template https://stackoverflow.com/questions/36637545/how-to-create-legend-continuous-colourbar-based-on-specific-range-of-values-in/36718315

tresult$net.damage_f<-cut(tresult$net.damage,
                      breaks = c(+Inf,10^9,10^8,10^7,-10^7,-10^8,-10^9,-10^10))

cols<-cols[c(1,5,9,13,17,21,25)]
cols[4]<-cols[1]<-"#FFFFFF" # Manually adding another bin for labels at the ends

ggplot(data = tresult,aes(x=scen.x, y=Name, fill=net.damage_f)) + 
  geom_tile() +
  scale_fill_manual(values = rev(cols), drop = FALSE, labels = rev(labs)) +
  facet_wrap(vars(SLR)) +
  coord_equal() +
  theme_minimal() +
  labs(x = "OLU Protection Scenario", y = "OLU") +
  theme(legend.position = "right", legend.key.size = unit(.5, 'cm'), legend.text=element_text(size=10)) +
  guides(fill=guide_legend(ncol = 1, label.position = "left", title.position = "top", title = "Net Change Damage ($)", label.vjust = -.75, reverse = TRUE))

#ggsave("Damage_grid.eps")

# Horizontal legend doesn't work because of expressions in legend labels - they are always left justified and can't be placed over breaks between bins
# ggplot(data = tresult,aes(x=scen.x, y=Name, fill=net.damage_f)) + 
#   geom_tile() +
#   scale_fill_manual(values = rev(cols), drop = FALSE, labels = labs) +
#   facet_wrap(vars(SLR)) +
#   coord_equal() +
#   theme_minimal() +
#   labs(x = "OLU Protection Scenario", y = "OLU") +
#   theme(legend.position = "bottom", legend.direction = "horizontal", legend.spacing.x = unit(0, 'cm')) +
#   guides(fill=guide_legend(nrow=1, label.position = "top", title.position = "top", title = "Net Change Damage ($)", label.hjust = 0))

```

## Net external damage from protection scenarios - individual impacts on external OLUs. Dashed vertical lines are sample means.

```{r, echo=FALSE}
tresult.ni$SLR<-as.factor(tresult.ni$SLR)

# ggplot(data = tresult.ni, aes(x=net.damage, fill = SLR, color = SLR)) +
#   geom_histogram(alpha=0.25, position="identity", bins = 100) +
#   scale_color_brewer(palette="Blues") +
#   scale_fill_brewer(palette="Blues") +
#   xlim(-100000000,100000000) +
#   theme_minimal() 

mu<-tresult.ni %>%
  group_by(SLR) %>%
  summarize(nd.mean = mean(net.damage,na.rm=TRUE))

getPalette<-colorRampPalette(brewer.pal(9, "YlGnBu")) # function, change if different palette is desired
cols<-getPalette(20) # Needs to be odd number to ensure midpoint color is correct
cols<-cols[c(5,10,15,20)]

ggplot(data = tresult.ni, aes(x=net.damage, color = SLR)) +
  stat_density(geom = "line", position = "identity") +
  #geom_histogram(alpha=0.8, position="identity") +
  geom_vline(data=mu, aes(xintercept=nd.mean), linetype="dashed", color=cols) +
  scale_color_manual(values=cols) +    
  coord_cartesian(xlim = c(-10^7.5,10^7.5)) +
  theme_minimal() +
  labs(title = "Mean external impact from a protection scenario on a given OLU", x = "Net external damage", y = "Density") 

# ggplot(data = tresult.ni, aes(x=net.damage)) +
#   geom_histogram() +
#   xlim(-100000000,100000000) +
#   facet_wrap(vars(SLR)) +
#   theme_minimal() 
```

```{r, echo=FALSE}

s.df.ni<-tresult.ni %>%
  group_by(SLR,scen.x) %>%
  summarize_at(vars(net.damage),sum)

mu<-s.df.ni %>%
  group_by(SLR) %>%
  summarize(nd.mean = mean(net.damage,na.rm=TRUE))

ggplot(data = s.df.ni, aes(x=net.damage, color = SLR)) +
  stat_density(geom = "line", position = "identity") +
  #geom_histogram(alpha=0.8, position="identity") +
  geom_vline(data=mu, aes(xintercept=nd.mean), linetype="dashed", color=cols) +
  scale_color_manual(values=cols) +    
  #xlim(-10^7.5,10^7.5) +
  theme_minimal() +
  labs(title = "Summed external impact from protection scenarios", x = "Net external damage", y = "Density") 
```

```{r, echo=FALSE, fig.align="center"}
mu<-s.df.ni %>%
  group_by(SLR) %>%
  summarize("max(net damage)" = max(net.damage))

kable(mu, caption = "Max external net damage from a protection scenario by SLR", digits = 1, format.args = list(big.mark = ","))

```

## Which OLUs have more to lose from external protection efforts?
```{r, echo=FALSE, fig.align="center"}
tresult.ni$Name<-as.factor(tresult.ni$Name)

# # Helper functions for reordering boxplot with facets https://stackoverflow.com/questions/47090344/how-to-properly-sort-facet-boxplots-by-median
# reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
#   new_x <- paste(x, within, sep = sep)
#   stats::reorder(new_x, by, FUN = fun)
# }
# 
# scale_x_reordered <- function(..., sep = "___") {
#   reg <- paste0(sep, ".+$")
#   ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
# }


ggplot(data = tresult.ni, aes(x=reorder(Name,-net.damage,FUN=median),y=net.damage)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(-100000000,100000000)) + 
  #facet_wrap(vars(SLR)) +
  theme_minimal() +
  labs(title = "Net internal damage by OLU from external protection scenarios", x = "OLU", y = "Net Damage") 
  #geom_jitter(shape=16, position=position_jitter(0.2))

```

## Relationship between OLU type and damages

```{r, include=FALSE, echo=FALSE}
df<-tresult
# Change in external damages
df<-df[which(df$Name!=df$scen.x),]
# Total external damages by OLU/SLR
df<-df %>%
  group_by(SLR,scen.x) %>%
  summarize_at(vars(net.damage),sum)
# NLCD 2016 raster
NLCD<-raster("./Data/NLCD_2016_Land_Cover_L48_20190424.tif")
# OLU shapefile
OLU<-st_read("./Data/olu_NAD83_10N.gpkg")
OLU<-OLU %>% arrange(OLU_ID)
OLU<-st_transform(OLU,crs=crs(NLCD))
tdf<-exact_extract(NLCD,OLU)
tdf<-rbindlist(tdf,idcol = TRUE)
# Cross tabulate OLU and land cover classes
tdf<-as.data.frame(table(tdf$.id,tdf$value))
# Long to wide format of land cover and flood damage data 
tdf<-spread(tdf,Var2,Freq) # http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/
df<-spread(df,SLR,net.damage)
# Merge
df<-merge(tdf,df,by.x="Var1",by.y="scen.x")
colnames(df)<-c("Var1", "X11","X21","X22","X23","X24","X31","X41","X42","X43","X52","X71","X81","X82","X90","X95","X128","SLR50","SLR100","SLR150","SLR200")
# Elevation
Ele<-raster("./Data/olu_dem90m.tif")
OLU<-st_transform(OLU,crs(Ele))
OLU$meanele<-exact_extract(Ele,OLU, "mean")
df<-merge(df,OLU,by.x="Var1",by.y="OLU_ID")
# Compressing classes 
dfm<-df
dfm$X1<-dfm$X11
dfm$X2<-dfm$X21+dfm$X22+dfm$X23+dfm$X24
dfm$X3<-dfm$X31
dfm$X4<-dfm$X41+dfm$X42+dfm$X43
dfm$X5<-dfm$X52
dfm$X7<-dfm$X71
dfm$X8<-dfm$X81+dfm$X82
dfm$X9<-dfm$X90+dfm$X95
# Percentages
dfp<-df[2:17]
dfptotal<-rowSums(dfp)
dfp<-dfp/dfptotal
# rowSums(dfp) # Confirming all rows add to 1
dfp<-cbind(Var1=df$Var1,dfp,SLR50=df$SLR50,SLR100=df$SLR100,SLR150=df$SLR150,SLR200=df$SLR200,meanele=df$meanele)
# Long regression using all SLR scenarios
dfa<-gather(dfp,SLR,net.damage,SLR50:SLR200)
# Qualitative assessment by OLU type
OLUclass<-df %>%
  group_by(Geomorphic) %>%
  summarize_at(vars(SLR50,SLR100,SLR150,SLR200,meanele),mean)
```

*OLU geomorphic type*

```{r, echo = FALSE, fig.align="center"}
kable(OLUclass, caption = "Mean external damage from protection, by OLU geomorphic type", digits = 1, format.args = list(big.mark = ","))
```

*NLCD analysis*

```{r figurename, echo=FALSE, fig.cap="NLCD 2016 Land Use Classification", out.width = '33%', fig.align="center"}
knitr::include_graphics("./Data/NLCD_Colour_Classification_Update.jpg")
```

**Landcover within geomorphic types - match color of letters to fill**
```{r `Tukey boxplot`, echo=FALSE, fig.align="center"}
lc<-df
lc$X2<-lc$X21+lc$X22+lc$X23+lc$X24
lc$X4<-lc$X41+lc$X42+lc$X43
lc$X8<-lc$X81+lc$X82
lc$X9<-lc$X90+lc$X95

lc<-subset(lc, select = c(X11,X2,X31,X4,X52,X71,X8,X9,Name,Geomorphic)) # Drops "X128"

lc<-lc %>%
  pivot_longer(!c(Name, Geomorphic), names_to="landcover", values_to="area")

# Area in km2, based on 30m2 raster cell size
lc$area<-(lc$area*900)/1000000

# Percentage of landcover vs total area
lc<-lc %>%
  group_by(Name) %>%
  mutate(Ptg = area/sum(area))

# Recoding landcover variables
lc<-mutate(lc, landcover = recode(landcover, "X11" = "Open Water", 
                              "X2" = "Development",
                              "X31" = "Barren",
                              "X4" = "Forest",
                              "X52" = "Shrub",
                              "X71" = "Grassland",
                              "X8" = "Pasture/Crops",
                              "X9" = "Wetlands"))


## Boxplot code roughly follows https://stackoverflow.com/questions/53038671/tukey-test-results-on-geom-boxplot-with-facet-grid
# Boxplot by total area
b<-ggplot(lc, aes(y=Geomorphic,x=area,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(rows = vars(landcover)) +
  theme_minimal() +
  theme(axis.text.y=element_blank(), strip.text.y = element_text(angle = 0)) +
  labs(y = "NLCD Land Cover Class", x = "Area (km2)", fill = "OLU Geomorphic Type")

generate_label_df <- function(TUKEY, variable){

  # Extract labels and factor levels from Tukey post-hoc 
  Tukey.levels <- variable[,4]
  Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])

  #I need to put the labels in the same order as in the boxplot :
  Tukey.labels$treatment=rownames(Tukey.labels)
  Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
  return(Tukey.labels)
}

for (l in as.character(unique(lc$landcover))) {   
  subdf <- subset(lc, landcover==l)
  model=lm(area ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$area, list(unique.values = subdf$Geomorphic), median)  
  yvalue$x<--5 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$landcover <- l

b<-b+geom_text(data = final,  aes(x=x, y=Geomorphic, label=Letters, color=Geomorphic), angle = 0, show.legend = FALSE)
  
}

ggsave(file="Landcover.eps")

b
```


**Regression 1** OLS regression of the general form *net external damage = f(mean elevation)*: observations at the OLU level (n=30), SLR 200

```{r, echo = FALSE, fig.align="center"}
# Regression
summary(mr<-lm(SLR200 ~ meanele,df))
```

**Regression 2** OLS regression of the general form *net external damage = f(land cover, mean elevation)*: observations at the OLU level (n=30), SLR 200

```{r, echo = FALSE, fig.align="center"}
# Regression
summary(mr<-lm(SLR200 ~ X11+X21+X23+X24+X31+X41+X42+X43+X52+X71+X81+X90+X95+meanele,df))
```

**Regression 3** Same as regression 2, but consolidating land cover types

```{r, echo = FALSE, fig.align="center"}
# Regression
summary(mr<-lm(SLR200 ~ X1+X2+X3+X4+X5+X7+X8+X9+meanele,dfm))
```

**Regression 3** Same as regression 2, but unconsolidated and using percentage of land cover type by OLU

```{r, echo = FALSE, fig.align="center"}
# Regression
summary(mr<-lm(SLR200 ~ X11+X21+X23+X24+X31+X41+X42+X43+X52+X71+X81+X90+X95+meanele,dfp))
```

**Regression 4** Unconsolidated regression using percentage of land cover type by OLU, all SLR scenarios

```{r, echo = FALSE, fig.align="center"}
summary(mr<-lm(net.damage ~ X11+X21+X23+X24+X31+X41+X42+X43+X52+X71+X81+X90+X95+meanele,dfa))
```

## Net benefits from protection across the entire bay

```{r, include = FALSE}
Exposure<-st_read("./Data/Exposure4OLU3.gpkg")
## Replacement cost values for structures
# Import replacement costs
RC<-read.csv("./Data/Replacement_cost.csv")
# Create structure values by census block
Exposure$V_RES1<-as.numeric(subset(RC,RC$Occup.Types == "RES1", select = "St_val")) * Exposure$RES1
Exposure$V_RES2<-as.numeric(subset(RC,RC$Occup.Types == "RES2", select = "St_val")) * Exposure$RES2
Exposure$V_RES3A<-as.numeric(subset(RC,RC$Occup.Types == "RES3A", select = "St_val")) * Exposure$RES3A
Exposure$V_RES3B<-as.numeric(subset(RC,RC$Occup.Types == "RES3B", select = "St_val")) * Exposure$RES3B
Exposure$V_RES3C<-as.numeric(subset(RC,RC$Occup.Types == "RES3C", select = "St_val")) * Exposure$RES3C
Exposure$V_RES3D<-as.numeric(subset(RC,RC$Occup.Types == "RES3D", select = "St_val")) * Exposure$RES3D
Exposure$V_RES3E<-as.numeric(subset(RC,RC$Occup.Types == "RES3E", select = "St_val")) * Exposure$RES3E
Exposure$V_RES3F<-as.numeric(subset(RC,RC$Occup.Types == "RES3F", select = "St_val")) * Exposure$RES3F
Exposure$V_RES4<-as.numeric(subset(RC,RC$Occup.Types == "RES4", select = "St_val")) * Exposure$RES4
Exposure$V_RES5<-as.numeric(subset(RC,RC$Occup.Types == "RES5", select = "St_val")) * Exposure$RES5
Exposure$V_RES6<-as.numeric(subset(RC,RC$Occup.Types == "RES6", select = "St_val")) * Exposure$RES6
Exposure$V_COM1<-as.numeric(subset(RC,RC$Occup.Types == "COM1", select = "St_val")) * Exposure$COM1
Exposure$V_COM2<-as.numeric(subset(RC,RC$Occup.Types == "COM2", select = "St_val")) * Exposure$COM2
Exposure$V_COM3<-as.numeric(subset(RC,RC$Occup.Types == "COM3", select = "St_val")) * Exposure$COM3
Exposure$V_COM4<-as.numeric(subset(RC,RC$Occup.Types == "COM4", select = "St_val")) * Exposure$COM4
Exposure$V_COM5<-as.numeric(subset(RC,RC$Occup.Types == "COM5", select = "St_val")) * Exposure$COM5
Exposure$V_COM6<-as.numeric(subset(RC,RC$Occup.Types == "COM6", select = "St_val")) * Exposure$COM6
Exposure$V_COM7<-as.numeric(subset(RC,RC$Occup.Types == "COM7", select = "St_val")) * Exposure$COM7
Exposure$V_COM8<-as.numeric(subset(RC,RC$Occup.Types == "COM8", select = "St_val")) * Exposure$COM8
Exposure$V_COM9<-as.numeric(subset(RC,RC$Occup.Types == "COM9", select = "St_val")) * Exposure$COM9
Exposure$V_COM10<-as.numeric(subset(RC,RC$Occup.Types == "COM10", select = "St_val")) * Exposure$COM10
Exposure$V_IND1<-as.numeric(subset(RC,RC$Occup.Types == "IND1", select = "St_val")) * Exposure$IND1
Exposure$V_IND2<-as.numeric(subset(RC,RC$Occup.Types == "IND2", select = "St_val")) * Exposure$IND2
Exposure$V_IND3<-as.numeric(subset(RC,RC$Occup.Types == "IND3", select = "St_val")) * Exposure$IND3
Exposure$V_IND4<-as.numeric(subset(RC,RC$Occup.Types == "IND4", select = "St_val")) * Exposure$IND4
Exposure$V_IND5<-as.numeric(subset(RC,RC$Occup.Types == "IND5", select = "St_val")) * Exposure$IND5
Exposure$V_IND6<-as.numeric(subset(RC,RC$Occup.Types == "IND6", select = "St_val")) * Exposure$IND6
Exposure$V_AGR1<-as.numeric(subset(RC,RC$Occup.Types == "AGR1", select = "St_val")) * Exposure$AGR1
Exposure$V_GOV1<-as.numeric(subset(RC,RC$Occup.Types == "GOV1", select = "St_val")) * Exposure$GOV1
Exposure$V_GOV2<-as.numeric(subset(RC,RC$Occup.Types == "GOV2", select = "St_val")) * Exposure$GOV2
Exposure$V_REL1<-as.numeric(subset(RC,RC$Occup.Types == "REL1", select = "St_val")) * Exposure$REL1
Exposure$V_EDU1<-as.numeric(subset(RC,RC$Occup.Types == "EDU1", select = "St_val")) * Exposure$EDU1
Exposure$V_EDU2<-as.numeric(subset(RC,RC$Occup.Types == "EDU2", select = "St_val")) * Exposure$EDU2
# County level cost adjustments https://stackoverflow.com/questions/38750535/extract-the-first-2-characters-in-a-string
Exposure$FIPS<-substr(Exposure$CnssBlc,start=1,stop=5)
CA<-read.csv("./Data/hzMeansCountyLocationFactor.csv", header = TRUE, colClasses=c("CountyFIPS"="character"))
Exposure$CostAdj<-(CA[match(Exposure$FIPS,CA$CountyFIPS),3])
# Import depth damage curves for structures and contents
Co<-read.csv("./Data/Contents_damage.csv")
St<-read.csv("./Data/Structures_damage.csv")
# Removing unneeded columns 
Exposure<-subset(Exposure, select = -c(Join_Count, TARGET_FID, Join_Cou_1, TARGET_F_1, Join_Cou_2, TARGET_F_2, Join_Cou_3, TARGET_F_3, Join_Cou_4, TARGET_F_4, RES1, RES2, RES3A, RES3B, RES3C, RES3D, RES3E, RES3F, RES4, RES5, RES6, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, COM10, IND1, IND2, IND3, IND4, IND5, IND6, AGR1, REL1, GOV1, GOV2, EDU1, EDU2))
# Removing unneeded variables
rm(CA, RC)
# Merge id (for water depth extraction)
Exposure$merge_id<-seq(1:nrow(Exposure))
# Sum of replacement value for each census block
Exposure$geom<-NULL
Exposure$trv<-rowSums(Exposure[3:35])
# OLU summed total replacement value and number of census blocks
Exp<-Exposure %>%
  group_by(Name) %>%
  summarize_at(vars(trv), list(numCB=length,sumtrv=sum))
# Renaming OLUs using scenario naming convention
Exp$scen.x<-as.character(Exp$Name)
Exp$scen.x<-ifelse(Exp$scen.x == "Golden Gate",30,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Mission - Islais",29,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Yosemite - Visitacion",28,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Colma - San Bruno",27,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "San Mateo",26,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Belmont - Redwood",25,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "San Francisquito",24,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Stevens",23,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Santa Clara Valley",22,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Mowry",21,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Alameda",20,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "San Lorenzo",19,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "San Leandro",18,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "East Bay Crescent",17,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Point Richmond",16,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Wildcat",15,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Pinole",14,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Carquinez South",13,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Walnut",12,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Port Chicago",11,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Montezuma Slough",10,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Suisun Slough",9,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Carquinez North",8,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Napa - Sonoma",7,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Petaluma",6,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Novato",5,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Gallinas",4,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "San Rafael",3,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Corte Madera",2,Exp$scen.x)
Exp$scen.x<-ifelse(Exp$scen.x == "Richardson",1,Exp$scen.x)
Exp$scen.x<-as.numeric(Exp$scen.x)
# tresult$SLR as character, to maintain variable ordering below
tresult$SLR<-as.character(tresult$SLR)
tresult$SLR<-ifelse(tresult$SLR=="50","050",tresult$SLR)
tresult<-tresult[order(tresult$SLR),]
# Internal change in damage and census blocks impacted by OLU
cf.i<-tresult[which(tresult$Name==tresult$scen.x),]
cf.i<-cf.i %>%
  pivot_wider(id_cols = c(scen.x,SLR), names_from=SLR, values_from = c(net.damage,net.impact))
# External change in damage and census blocks impacted by OLU
cf.e<-tresult[which(tresult$Name!=tresult$scen.x),]
cf.e<-cf.e %>%
  group_by(SLR,scen.x) %>%
  summarize_at(vars(net.damage,net.impact),sum)
cf.e<-cf.e %>%
  pivot_wider(id_cols = c(scen.x,SLR), names_from=SLR, values_from = c(net.damage,net.impact))
# Merge into one table
cf<-left_join(Exp, cf.i, by='scen.x') %>%
                left_join(., cf.e, by='scen.x') 
colnames(cf)<-c("Name","numCB","sumtrv","OLUid","i.dmg.050","i.dmg.100","i.dmg.150", "i.dmg.200","i.cb.050","i.cb.100","i.cb.150", "i.cb.200","e.dmg.050","e.dmg.100","e.dmg.150", "e.dmg.200","e.cb.050","e.cb.100","e.cb.150", "e.cb.200")
# Overall effect
cf2<-cf
cf2$dmg.050<-cf2$i.dmg.050+cf2$e.dmg.050
cf2$dmg.100<-cf2$i.dmg.100+cf2$e.dmg.100
cf2$dmg.150<-cf2$i.dmg.150+cf2$e.dmg.150
cf2$dmg.200<-cf2$i.dmg.200+cf2$e.dmg.200
cf2$cb.050<-cf2$i.cb.050+cf2$e.cb.050
cf2$cb.100<-cf2$i.cb.100+cf2$e.cb.100
cf2$cb.150<-cf2$i.cb.150+cf2$e.cb.150
cf2$cb.200<-cf2$i.cb.200+cf2$e.cb.200
excl<-names(cf2) %in% c("i.dmg.050","i.dmg.100","i.dmg.150","i.dmg.200","i.cb.050","i.cb.100","i.cb.150","i.cb.200","e.dmg.050","e.dmg.100","e.dmg.150", "e.dmg.200","e.cb.050","e.cb.100","e.cb.150", "e.cb.200")
cf2<-cf2[!excl]
cf2<-cf2[order(cf2$OLUid),]
cf2$sumtrv<-round(cf2$sumtrv/1000000, 1) # Total replacement value in millions
cf2$dmg.050<-round(cf2$dmg.050/1000000, 1)
cf2$dmg.100<-round(cf2$dmg.100/1000000, 1)
cf2$dmg.150<-round(cf2$dmg.150/1000000, 1)
cf2$dmg.200<-round(cf2$dmg.200/1000000, 1)
cf2<-subset(cf2, select = -c(numCB,cb.050,cb.100,cb.150,cb.200))
cf2<-cf2[,c(3,1,2,4,5,6,7)]

# Geomorphic type and area
gt<-subset(OLU, select = c(Name, Geomorphic, geom))
gt$area<-st_area(gt)
cf2<-left_join(cf2, gt, by='Name')
cf2$area<-(as.vector(cf2$area)/1000000) # Removing units attribute (m2) and converting to km2
cf2$trvkm2<-cf2$sumtrv/cf2$area

boxplot(trvkm2~Geomorphic,data=cf2)
# Tukey test
amod<-aov(trvkm2~Geomorphic,data=cf2) # change this for relevant comparison
#plot(amod) 
TukeyHSD(amod)

```

```{r, echo = FALSE, fig.align="center"}
kable(within(cf2,rm(geom)), caption = "Baywide net damage and net impacted census blocks from protection, across SLR scenarios. Net = internal + external", digits = 1, format.args = list(big.mark = ","))
cf2$area<-round(cf2$area, 1)
cf2$trvkm2<-round(cf2$trvkm2, 1)
kable(within(cf2,rm(geom)),format = "latex")
```

*sumrtv = total replacement value of structures*, *numCB = total # of census blocks*, 

## Water attributes by OLU

```{r, include=FALSE, fig.align="center"}
fresult<-read.csv("fresult.csv")
fresult.ni<-fresult[which(fresult$OLU!=fresult$scen.x),]
```

```{r, echo=FALSE, fig.align="center"}
cols<-getPalette(25) 
labs<-expression(paste("10"^"8"),paste("10"^"7"),paste("10"^"6"),paste("10"^"5"),paste("-10"^"5"),paste("-10"^"6"),paste("-10"^"7"),paste("-10"^"8"),paste("-10"^"9"))

fresult$net.volume_f<-cut(fresult$net.volume,
                      breaks = c(+Inf,10^8,10^7,10^6,10^5,-10^5,-10^6,-10^7,-10^8,-10^9))

cols<-cols[c(1,4,7,10,13,16,19,22,25)]
cols[1]<-cols[5]<-"#FFFFFF"

ggplot(data = fresult,aes(x=scen.x, y=OLU, fill=net.volume_f)) + 
  geom_tile() +
  scale_fill_manual(values = rev(cols), drop = FALSE, labels = rev(labs)) +
  facet_wrap(vars(SLR)) +
  coord_equal() +
  theme_minimal() +
  labs(x = "OLU Protection Scenario", y = "OLU") +
  theme(legend.position = "right", legend.key.size = unit(.5, 'cm'), legend.text=element_text(size=10)) +
  guides(fill=guide_legend(ncol = 1, label.position = "left", title.position = "top", title = "Net Change Volume (Cubic Meters)", label.vjust = -1, reverse = TRUE))

#ggsave(file="Volume_grid.eps")
```

```{r, echo=FALSE, fig.align="center"}
# Template https://stackoverflow.com/questions/36637545/how-to-create-legend-continuous-colourbar-based-on-specific-range-of-values-in/36718315
ggplot(data = fresult, aes(x=scen.x, y=OLU, fill=net.volume)) + 
  geom_tile() + 
    geom_hline(yintercept=17.5, linetype="dashed", color = "black") +
  geom_vline(xintercept=17.5, linetype="dashed", color = "black") +
  scale_fill_gradientn(colours = cols, values = rescale(colscale), breaks = colscale, labels = labs, name="Net Change Volume (Cubic Meters)", guide=guide_legend(), limits = c(-10^12,10^9)) +
  facet_wrap(vars(SLR)) +
  coord_equal() +
  theme_minimal() +
  labs(x = "OLU Protection Scenario", y = "OLU") +
  theme(legend.text.align = 0) 
#ggsave(file="name.eps")
```

```{r, include=FALSE}
Pop<-raster("./Data/dasymetric_us_20160208.tif")
OLU<-st_transform(OLU, st_crs(Pop))
OLU$sumpop<-exact_extract(Pop, OLU, "sum")
sum(OLU$sumpop)
```

```{r, echo=FALSE, fig.align="center"}
ggplot(OLU) +
  geom_sf(aes(fill = sumpop)) +
  theme_minimal() +
  labs(fill="Population")
```

## Figure - Highway 37 example
```{r, include=FALSE, echo=FALSE}
H37<-st_read("./Data/Roads_2015.gpkg")
H37<-filter(H37, FULLNAME %in% c("State Rte 37")) # Leaves out "State Hwy 37" to focus more on OLU7
H37<-st_transform(H37, st_crs(OLU))
```


```{r, echo=FALSE, fig.align="center"}
# Flood maps are in meters
SLR100<-raster("./Data/100/olu_00000-0-0-000-000000-00000-00-00000-00_depth.tif")

OLU7<-filter(OLU, OLU_ID %in% c("7")) # http://zevross.com/blog/2018/10/02/creating-beautiful-demographic-maps-in-r-with-the-tidycensus-and-tmap-packages/
OLUn7<-filter(OLU, !OLU_ID %in% c("7"))

getPalette<-colorRampPalette(brewer.pal(5, "Blues")) # function, change if different palette is desired
cols<-getPalette(5)

# Guidance for tmaps package https://geocompr.robinlovelace.net/adv-map.html

tmap_options(max.raster = c(plot = 1e7, view = 1e6)) # 4e7

OLU7f<-tm_shape(SLR100, bbox=H37) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)", colorNA = "white", textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_scale_bar() +
  tm_shape(H37) +
  tm_lines(col = "black", lty = "dashed") +
  tm_layout(frame = FALSE)
  #tm_shape(OLU7) +
  #tm_borders(col = "black", lwd = 1.25)

OLU7f

tmap_save(OLU7f,"OLU7f.eps") # https://rdrr.io/cran/tmap/man/tmap_save.html
```

## Figure - OLUs 25 and 26

```{r, echo=FALSE, fig.align="center"}
# Flood maps are in meters
SLR50<-raster("./Data/50/olu_00000-0-0-000-000000-00000-00-00000-00_depth.tif")
SLR50.26<-raster("./Data/50/olu_00000-0-0-000-000000-00000-00-00100-00_depth.tif")
SLR100.26<-raster("./Data/100/olu_00000-0-0-000-000000-00000-00-00100-00_depth.tif")
SLR150<-raster("./Data/150/olu_00000-0-0-000-000000-00000-00-00000-00_depth.tif")
SLR150.26<-raster("./Data/150/olu_00000-0-0-000-000000-00000-00-00100-00_depth.tif")  

OLU2526<-filter(OLU, OLU_ID %in% c("25","26")) # http://zevross.com/blog/2018/10/02/creating-beautiful-demographic-maps-in-r-with-the-tidycensus-and-tmap-packages/
OLU26<-filter(OLU, OLU_ID %in% c("26"))

getPalette<-colorRampPalette(brewer.pal(5, "Blues")) # function, change if different palette is desired
cols<-getPalette(5)

#tmap_options(max.raster = c(plot = 1e5, view = 1e5)) # 3e7

# Modifying the bounding box https://www.jla-data.net/eng/adjusting-bounding-box-of-a-tmap-map/
bbox_new<-st_bbox(OLU2526)
xrange <- bbox_new$xmax - bbox_new$xmin
yrange <- bbox_new$ymax - bbox_new$ymin
  bbox_new[1] <- bbox_new[1] + (0.25 * xrange) # xmin - left +.25
  bbox_new[3] <- bbox_new[3] - (0.62 * xrange) # xmax - right -.62
  bbox_new[2] <- bbox_new[2] + (0.40 * yrange) # ymin - bottom +.4
  bbox_new[4] <- bbox_new[4] - (0.10 * yrange) # ymax - top -.1
bbox_new <- bbox_new %>%  # take the bounding box ...
  st_as_sfc() # ... and make it a sf polygon

m50<-tm_shape(SLR50, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = TRUE) +
  #tm_scale_bar(position = c("left","bottom")) +
  #tm_shape(OLU26) +
  #tm_borders(col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

m100<-tm_shape(SLR100, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = FALSE) +
  tm_scale_bar(position = c("left","bottom")) +
  #tm_shape(OLU26) +
  #tm_borders(col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

m50.26<-tm_shape(SLR50.26, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = FALSE) +
  #tm_scale_bar() +
  tm_shape(OLU26) +
  tm_polygons(col="white", border.col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

m100.26<-tm_shape(SLR100.26, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = FALSE) +
  #tm_scale_bar() +
  tm_shape(OLU26) +
  tm_polygons(col="white", border.col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

m150<-tm_shape(SLR150, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = FALSE) +
  #tm_scale_bar() +
  #tm_shape(OLU26) +
  #tm_borders(col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

m150.26<-tm_shape(SLR150.26, bbox=bbox_new) +
  tm_raster(style = "fixed", breaks=seq(0, 5, by=1), labels = c("<1","1 - 2","2 - 3","3 - 4",">4"), palette = cols, title = "Water Depth (m)",colorNA = "white",textNA = "") +
  tm_shape(OLU) +
  tm_borders(col = "grey") +
  tm_layout(frame = TRUE, legend.show = FALSE) +
  #tm_scale_bar() +
  tm_shape(OLU26) +
  tm_polygons(col="white", border.col = "black", lwd = 1.25) +
  tm_legend(legend.position = c("left", "bottom"))

OLU2526f<-tmap_arrange(m50,m100,m150,m50.26,m100.26,m150.26,ncol = 3)

OLU2526f

tmap_save(OLU2526f,"OLU2526f.eps") # https://rdrr.io/cran/tmap/man/tmap_save.html
```



```{r `boxplot data prep`, include=FALSE}
## Preparing data for statistical tests of boxplot figure 

## Damage data
# Internal 
gf.i<-tresult[which(tresult$Name==tresult$scen.x),]
gf.i<-dplyr::select(gf.i, c(SLR,scen.x,net.damage))
gf.i$Type<-"internal"
# External change in damage and census blocks impacted by OLU
gf.e<-tresult[which(tresult$Name!=tresult$scen.x),]
gf.e<-gf.e %>%
  group_by(SLR,scen.x) %>%
  summarize_at(vars(net.damage),sum)
gf.e$Type<-"external"
# Merge and calculate net damage
gf<-merge(gf.e, gf.i, by=c('scen.x','SLR'))
gf$net.damage.z<-gf$net.damage.x+gf$net.damage.y
gf$Type.z<-"net"

# Long format
# Alt to pivot longer https://community.rstudio.com/t/pivot-longer-on-multiple-column-sets-pairs/43958/2
col_names<-c("SLR","OLUid","Damage","Type")
gf.i<-dplyr::select(gf, c(SLR, scen.x, net.damage.y, Type.y)) %>% set_names(col_names)
gf.e<-dplyr::select(gf, c(SLR, scen.x, net.damage.x, Type.x)) %>% set_names(col_names)
gf.n<-dplyr::select(gf, c(SLR, scen.x, net.damage.z, Type.z)) %>% set_names(col_names)
gf<-bind_rows(gf.i,gf.e,gf.n)

# Character to integer
gf$SLR<-as.numeric(gf$SLR)

## Flood data
# Internal
bf.i<-fresult[which(fresult$OLU==fresult$scen.x),]
bf.i<-subset(bf.i, select = c(SLR,scen.x,net.volume))
bf.i$Type<-"internal"
# External
bf.e<-fresult[which(fresult$OLU!=fresult$scen.x),]
bf.e<-bf.e %>%
  group_by(SLR,scen.x) %>%
  summarize_at(vars(net.volume),sum)
bf.e$Type<-"external"
# Merge and calculate net flooding
bf<-merge(bf.e, bf.i, by=c('scen.x','SLR'))
bf$net.volume.z<-bf$net.volume.x+bf$net.volume.y
bf$Type.z<-"net"

# Long format
# Alt to pivot longer https://community.rstudio.com/t/pivot-longer-on-multiple-column-sets-pairs/43958/2
col_names<-c("SLR","OLUid","Volume","Type")
bf.i<-dplyr::select(bf, c(SLR, scen.x, net.volume.y, Type.y)) %>% set_names(col_names)
bf.e<-dplyr::select(bf, c(SLR, scen.x, net.volume.x, Type.x)) %>% set_names(col_names)
bf.n<-dplyr::select(bf, c(SLR, scen.x, net.volume.z, Type.z)) %>% set_names(col_names)
bf<-bind_rows(bf.i,bf.e,bf.n)


# Joining damage and flood data
stst<-left_join(gf,bf,by=c("OLUid", "Type", "SLR"))
stst$Damage<-stst$Damage/1000000
stst$Volume<-stst$Volume/1000000

# Adding geomorphic info
stst<-OLU %>% 
  st_drop_geometry() %>%
  dplyr::select(.,c(Geomorphic,OLU_ID)) %>%
  set_names(.,c("Geomorphic","OLUid")) %>%
  left_join(stst,.,by="OLUid")

```

```{r `Tukey boxplot figs prep`, echo=FALSE, fig.align="center"}
# Recoding SLR variables https://stackoverflow.com/questions/43290483/r-changing-order-of-facets
stst$SLR<-ifelse(stst$SLR==50,"50cm",
                 ifelse(stst$SLR==100,"100cm",
                        ifelse(stst$SLR==150,"150cm","200cm")))
stst$SLR<-as.factor(stst$SLR)
stst$SLR<-factor(stst$SLR, levels = c('50cm','100cm','150cm','200cm'))


d_i<-ggplot(stst[stst$Type=="internal",], aes(x=Geomorphic,y=Damage,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-4000, 1500)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(), legend.box = "horizontal") +
  labs(subtitle = "(b)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="internal",], SLR==l)
  model=lm(Damage ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Damage, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l) # as.factor here is to make sure factor ordering set above is preserved

d_i<-d_i+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.0, hjust=-0.1, show.legend = FALSE)
  
}

d_e<-ggplot(stst[stst$Type=="external",], aes(x=Geomorphic,y=Damage,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-250, 750)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(), legend.box = "horizontal") +
  labs(subtitle = "(d)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="external",], SLR==l)
  model=lm(Damage ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Damage, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l)

d_e<-d_e+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.0, hjust=-0.1, show.legend = FALSE)
  
}

d_n<-ggplot(stst[stst$Type=="net",], aes(x=Geomorphic,y=Damage,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-4000, 1500)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(), legend.box = "horizontal") +
  labs(subtitle = "(f)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="net",], SLR==l)
  model=lm(Damage ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Damage, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l)

d_n<-d_n+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.0, hjust=-0.1, show.legend = FALSE)
}

v_i<-ggplot(stst[stst$Type=="internal",], aes(x=Geomorphic,y=Volume,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-600, 300)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(), legend.box = "horizontal") +
  labs(subtitle = "(a)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="internal",], SLR==l)
  model=lm(Volume ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Volume, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l)

v_i<-v_i+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.5, hjust=-0.1, show.legend = FALSE)
  
}

v_e<-ggplot(stst[stst$Type=="external",], aes(x=Geomorphic,y=Volume,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-10, 25)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(),legend.box = "horizontal") +
  labs(subtitle = "(c)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="external",], SLR==l)
  model=lm(Volume ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Volume, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l)

v_e<-v_e+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.0, hjust=-0.1, show.legend = FALSE)
  
}

v_n<-ggplot(stst[stst$Type=="net",], aes(x=Geomorphic,y=Volume,fill=Geomorphic)) +
  geom_boxplot(outlier.shape = NA) +
  facet_grid(.~SLR) +
  theme_minimal() +
  coord_cartesian(ylim=c(-600, 300)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank(), legend.box = "horizontal") +
  labs(subtitle = "(e)")

for (l in as.character(unique(stst$SLR))) {   
  subdf <- subset(stst[stst$Type=="net",], SLR==l)
  model=lm(Volume ~ Geomorphic, data=subdf)
  ANOVA=aov(model)
  TUKEY <- TukeyHSD(ANOVA)
  labels <- generate_label_df(TUKEY , TUKEY$`Geomorphic`)
  names(labels) <- c('Letters','Geomorphic')
  yvalue <- aggregate(subdf$Volume, list(unique.values = subdf$Geomorphic), quantile, probs=.75)  
  #yvalue$x<-500 # overwriting prior line
  final <- merge(labels, yvalue, by.x = "Geomorphic", by.y = "unique.values")
  final$SLR <- as.factor(l)

v_n<-v_n+geom_text(data = final,  aes(y=x, x=Geomorphic, label=Letters, color=Geomorphic), vjust=-1.0, hjust=-0.1, show.legend = FALSE)

}

z<-ggarrange(v_i,d_i,v_e,d_e,v_n,d_n, ncol = 2, nrow = 3, label.x = 0.05, label.y = 0.2, common.legend = TRUE)


```

```{r `Boxplot volume-damage`, echo=FALSE, fig.align="center", warning=FALSE}
# Column and row titles using patchwork https://stackoverflow.com/questions/60347583/add-row-and-column-titles-with-ggarrange

row1 <- ggplot() + annotate(geom = 'text', x=1, y=1, label="Internal", angle = 0) + theme_void() 

row2 <- ggplot() + annotate(geom = 'text', x=1, y=1, label="External", angle = 0) + theme_void() 

row3 <- ggplot() + annotate(geom = 'text', x=1, y=1, label="Net", angle = 0) + theme_void()

col1 <- ggplot() + annotate(geom = 'text', x=1, y=1, label=expression(paste("Volume (Millions ", "m"^"3",")"))) + theme_void() 

col2 <- ggplot() + annotate(geom = 'text', x=1, y=1, label="Damage (USD millions)") + theme_void() 

layoutplot <- "
ccc#ddd
eeeafff
eeeafff
gggbhhh
gggbhhh
iiikjjj
iiikjjj
"


plotlist <- list(a = row1, b = row2, c = col1, d = col2, e=v_i, f=d_i, g=v_e, h=d_e, i=v_n, j=d_n, k=row3)

y<-wrap_plots(plotlist, guides = 'collect', design = layoutplot) & theme(legend.position = 'bottom') 
#v_i + d_i + v_e + d_e + v_n + d_n + plot_layout(guides = "collect", ncol = 2) & theme(legend.position = 'bottom')

ggsave("Boxplot.eps")

y

```
```{r}
SLR_comp_v<-ggplot(stst[stst$Type=="external",], aes(x=SLR,y=Volume,fill=SLR)) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

SLR_comp_d<-ggplot(stst[stst$Type=="external",], aes(x=SLR,y=Damage,fill=SLR)) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

bf.e_comp<-ggplot(bf.e, aes(x=as.factor(SLR),y=Volume,fill=as.factor(SLR))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")
  
SLR_comp_v + SLR_comp_d + bf.e_comp  
```

```{r}
q1<-ggplot(fresult.ni, aes(x=as.factor(SLR),y=net.volume,fill=as.factor(SLR))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  coord_cartesian(ylim=c(-250000, 250000)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

q2<-ggplot(tresult.ni, aes(x=as.factor(SLR),y=net.damage,fill=as.factor(SLR))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  coord_cartesian(ylim=c(-15000000, 15000000)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

q1/q2
```

```{r}
q3<-ggplot(tresult.ni[tresult.ni$Name==22,], aes(x=as.factor(SLR),y=net.damage,fill=as.factor(SLR))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  coord_cartesian(ylim=c(-55000000, 55000000)) +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

q4<-ggplot(tresult.ni[tresult.ni$Name==22,], aes(x=as.factor(SLR),y=mean.x,fill=as.factor(SLR))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x=element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.box = "horizontal")

q3/q4
```